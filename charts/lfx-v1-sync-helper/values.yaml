# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
# replicas is the number of service instances to run for horizontal scaling
replicas: 1

# image is the configuration for the container images
image:
  # repository is the container image repository
  repository: ghcr.io/linuxfoundation/lfx-v1-sync-helper/lfx-v1-sync-helper
  # tag is the container image tag (overrides appVersion from Chart.yaml)
  tag: ""
  # pullPolicy is the image pull policy
  pullPolicy: IfNotPresent

# app is the configuration for the application
app:
  environment:
    # NATS_URL is required
    NATS_URL:
      value: nats://lfx-platform-nats.lfx.svc.cluster.local:4222
    # LOG_LEVEL is optional
    LOG_LEVEL:
      value: info
    # DEBUG is optional
    DEBUG:
      value: "false"
    # PORT is optional
    PORT:
      value: "8080"
    # BIND is optional
    BIND:
      value: "*"
    # PROJECT_SERVICE_URL is required for making API calls to project service
    PROJECT_SERVICE_URL:
      value: http://lfx-v2-project-service.lfx.svc.cluster.local:8080
    # COMMITTEE_SERVICE_URL is required for making API calls to committee service
    COMMITTEE_SERVICE_URL:
      value: http://lfx-v2-committee-service.lfx.svc.cluster.local:8080

# serviceAccount is the configuration for the Kubernetes service account
serviceAccount:
  # create specifies whether a service account should be created
  create: true
  # name is the name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""
  # annotations to add to the service account
  annotations: {}
  # automountServiceAccountToken is a boolean to determine if the service account token should be automatically mounted
  automountServiceAccountToken: true

# nats is the configuration for the NATS server
nats:
  # kv_bucket_v1_objects is the configuration for the KV bucket for storing v1 objects from Meltano
  kv_bucket_v1_objects:
    # creation is a boolean to determine if the KV bucket should be created via the helm chart.
    # set it to false if you want to use an existing KV bucket.
    creation: true
    # keep is a boolean to determine if the KV bucket should be preserved during helm uninstall
    # set it to false if you want the bucket to be deleted when the chart is uninstalled
    keep: true
    # name is the name of the KV bucket for storing v1 objects
    name: v1-objects
    # history is the number of history entries to keep for the KV bucket
    history: 20
    # storage is the storage type for the KV bucket
    storage: file
    # maxValueSize is the maximum size of a value in the KV bucket
    maxValueSize: 10485760 # 10MB
    # maxBytes is the maximum number of bytes in the KV bucket
    maxBytes: 10737418240 # 10GB
    # compression is a boolean to determine if the KV bucket should be compressed
    compression: true

  # kv_bucket_v1_mappings is the configuration for the KV bucket for storing v1 ID mappings
  kv_bucket_v1_mappings:
    # creation is a boolean to determine if the KV bucket should be created via the helm chart.
    # set it to false if you want to use an existing KV bucket.
    creation: true
    # keep is a boolean to determine if the KV bucket should be preserved during helm uninstall
    # set it to false if you want the bucket to be deleted when the chart is uninstalled
    keep: true
    # name is the name of the KV bucket for storing v1 ID mappings
    name: v1-mappings
    # history is the number of history entries to keep for the KV bucket
    history: 20
    # storage is the storage type for the KV bucket
    storage: file
    # maxValueSize is the maximum size of a value in the KV bucket
    maxValueSize: 10485760 # 10MB
    # maxBytes is the maximum number of bytes in the KV bucket
    maxBytes: 2147483648 # 2GB
    # compression is a boolean to determine if the KV bucket should be compressed
    compression: true

  # consumer is the configuration for the NATS JetStream consumer that processes v1-objects KV bucket changes
  consumer:
    # creation is a boolean to determine if the consumer should be created via the helm chart
    # set it to false if you want to use an existing consumer
    creation: true
    # keep is a boolean to determine if the consumer should be preserved during helm uninstall
    # set it to false if you want the consumer to be deleted when the chart is uninstalled
    keep: true
    # name is the name of the consumer
    name: v1-sync-helper-kv-consumer
    # streamName is the name of the JetStream stream that contains the KV bucket
    streamName: KV_v1-objects

    # ackPolicy determines how messages are acknowledged
    ackPolicy: explicit
    # deliverPolicy determines which messages to deliver
    # uncomment "lastPerSubject" when it's fixed upstream in NACK
    # deliverPolicy: lastPerSubject
    deliverPolicy: all
    # maxDeliver is the maximum number of delivery attempts
    maxDeliver: 3
    # ackWait is how long to wait for an acknowledgment
    ackWait: 30s
    # maxAckPending is the maximum number of unacknowledged messages
    maxAckPending: 1000
    # filterSubject allows filtering specific keys (use ">" for all)
    filterSubject: "$KV.v1-objects.>"

# heimdall is the configuration for JWT authentication and impersonation
heimdall:
  enabled: true
  url: http://lfx-platform-heimdall.lfx.svc.cluster.local:4456
  # secret contains the JWT configuration for authentication
  secret:
    # name of the secret containing JWT private key and configuration
    name: lfx-platform-heimdall-jwt-config
    # clientId for JWT principal and subject claims (defaults to "v1_sync_helper")
    clientIdKey: client-id
    # privateKey for JWT token signing
    privateKeyKey: private-key
