# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
# Meltano DynamoDB ETL CronJob for extracting data from ITX DynamoDB and loading to NATS KV.
{{- if .Values.meltano.dynamodbEtl.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Chart.Name }}-meltano-dynamodb
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/component: meltano
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
spec:
  schedule: {{ .Values.meltano.dynamodbEtl.schedule | quote }}
  concurrencyPolicy: {{ .Values.meltano.dynamodbEtl.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ .Values.meltano.dynamodbEtl.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.meltano.dynamodbEtl.failedJobsHistoryLimit }}
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name }}
        app.kubernetes.io/component: meltano
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/managed-by: {{ .Release.Service }}
    spec:
      ttlSecondsAfterFinished: {{ .Values.meltano.dynamodbEtl.ttlSecondsAfterFinished }}
      backoffLimit: {{ .Values.meltano.dynamodbEtl.backoffLimit }}
      template:
        metadata:
          labels:
            app.kubernetes.io/name: {{ .Chart.Name }}
            app.kubernetes.io/component: meltano
            app.kubernetes.io/instance: {{ .Release.Name }}
            app.kubernetes.io/managed-by: {{ .Release.Service }}
        spec:
          restartPolicy: Never
          serviceAccountName: {{ .Values.serviceAccount.name | default .Chart.Name }}
          containers:
            - name: meltano
              image: "{{ .Values.meltano.dynamodbEtl.image.repository }}:{{ .Values.meltano.dynamodbEtl.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.meltano.dynamodbEtl.image.pullPolicy }}
              workingDir: /app/meltano
              # Meltano args must be in specific order: el [--catalog path] [--state-id id] <tap> <target>
              args:
                - "el"
                {{- if and .Values.meltano.dynamodbEtl.catalog.enabled .Values.meltano.dynamodbEtl.catalog.configMap.name }}
                - "--catalog"
                - "{{ .Values.meltano.dynamodbEtl.catalog.configMap.mountPath }}/{{ .Values.meltano.dynamodbEtl.catalog.configMap.key }}"
                {{- end }}
                - "--state-id"
                - {{ .Values.meltano.dynamodbEtl.stateId | quote }}
                - "tap-dynamodb"
                - "target-nats-kv"
              env:
                # Meltano environment configuration
                - name: MELTANO_ENVIRONMENT
                  value: {{ .Values.meltano.dynamodbEtl.environment | quote }}
                - name: MELTANO_STATE_BACKEND_URI
                  value: "s3://{{ .Values.meltano.dynamodbEtl.aws.stateBucketPrefix }}-{{ .Values.meltano.dynamodbEtl.environment }}"
                # AWS configuration
                - name: AWS_DEFAULT_REGION
                  value: {{ .Values.meltano.dynamodbEtl.aws.region | quote }}
                - name: AWS_REGION
                  value: {{ .Values.meltano.dynamodbEtl.aws.region | quote }}
                # DynamoDB tap cross-account assume role configuration
                - name: TAP_DYNAMODB_AWS_ASSUME_ROLE_ARN
                  {{/* Cast the accountId to int64 first, in case it is stored in yaml as a number. If it is a number it is long enough that
                      it gets written out in scientific notation. This method is safe regardless of if it is a string or number. */}}
                  value: {{ printf "arn:aws:iam::%s:role/%s" (required "meltano.dynamodbEtl.aws.itx.accountId is required when dynamodbEtl is enabled" (.Values.meltano.dynamodbEtl.aws.itx.accountId | int64 | toString)) .Values.meltano.dynamodbEtl.aws.itx.roleName | quote }}
                - name: TAP_DYNAMODB_AWS_DEFAULT_REGION
                  value: {{ .Values.meltano.dynamodbEtl.aws.region | quote }}
                # DynamoDB table scan filtering for incremental loads
                - name: TAP_DYNAMODB_TABLE_SCAN_KWARGS
                  value: |
                    {
                      {{- $tables_with_modified_at := .Values.meltano.dynamodbEtl.filtering.tablesWithModifiedAt }}
                      {{- $duration := .Values.meltano.dynamodbEtl.filtering.duration }}
                      {{- $startTime := now | dateModify (printf "-%s" $duration) | date "2006-01-02T15:04:05Z" }}
                      {{- range $index, $table := $tables_with_modified_at }}
                        {{ $table | quote }}: {
                          "FilterExpression": "modified_at > :startTime",
                          "ExpressionAttributeValues": {
                            ":startTime": {{ $startTime | quote }}
                          },
                          "ConsistentRead": false
                        }{{ if lt $index (sub (len $tables_with_modified_at) 1) }},{{ end }}
                      {{- end }}
                    }
                # Target NATS KV configuration
                - name: TARGET_NATS_KV_URL
                  value: {{ .Values.meltano.dynamodbEtl.nats.url | quote }}
                - name: TARGET_NATS_KV_BUCKET
                  value: {{ .Values.meltano.dynamodbEtl.nats.bucket | quote }}
                - name: TARGET_NATS_KV_REFRESH_MODE
                  value: {{ .Values.meltano.dynamodbEtl.nats.refreshMode | quote }}
                - name: TARGET_NATS_KV_VALIDATE_RECORDS
                  value: {{ .Values.meltano.dynamodbEtl.nats.validateRecords | quote }}
                - name: TARGET_NATS_KV_MSGPACK
                  value: {{ .Values.meltano.dynamodbEtl.nats.useMessagePack | quote }}
              resources:
                {{- toYaml .Values.meltano.dynamodbEtl.resources | nindent 16 }}
              livenessProbe:
                exec:
                  command: ["pgrep", "-f", "meltano"]
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 3
              {{- if and .Values.meltano.dynamodbEtl.catalog.enabled .Values.meltano.dynamodbEtl.catalog.configMap.name }}
              volumeMounts:
                - name: tap-dynamodb-catalog
                  mountPath: {{ .Values.meltano.dynamodbEtl.catalog.configMap.mountPath }}
                  readOnly: true
              {{- end }}
          {{- if and .Values.meltano.dynamodbEtl.catalog.enabled .Values.meltano.dynamodbEtl.catalog.configMap.name }}
          volumes:
            - name: tap-dynamodb-catalog
              configMap:
                name: {{ .Values.meltano.dynamodbEtl.catalog.configMap.name }}
          {{- end }}
{{- end }}
