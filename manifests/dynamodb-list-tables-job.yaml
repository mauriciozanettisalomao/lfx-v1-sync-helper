# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
#
# Simple test Job to verify cross-account DynamoDB access permissions.
# This job assumes the ITX v1-meltano-sync role and lists DynamoDB tables to confirm
# cross-account assume role is working properly for DEV environment.
---
apiVersion: batch/v1
kind: Job
metadata:
  name: dynamodb-list-tables-job
  namespace: v1-sync-helper
  labels:
    app.kubernetes.io/name: lfx-v1-sync-helper
    app.kubernetes.io/component: aws-test
    app.kubernetes.io/test-type: dynamodb-list
spec:
  ttlSecondsAfterFinished: 1800 # Clean up job after 30 minutes
  backoffLimit: 2 # Retry twice for network issues
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lfx-v1-sync-helper
        app.kubernetes.io/component: aws-test
        app.kubernetes.io/test-type: dynamodb-list
    spec:
      restartPolicy: Never
      serviceAccountName: v1-sync-helper-sa
      containers:
        - name: aws-cli
          image: amazon/aws-cli:2.15.30
          imagePullPolicy: IfNotPresent
          command:
            - "sh"
            - "-c"
            - |
              echo "=== Testing DynamoDB Cross-Account Access ==="
              echo "AWS Region: ${AWS_DEFAULT_REGION}"
              echo "Assuming role: ${ROLE_ARN}"

              # Assume role for cross-account access to ITX DynamoDB
              echo "Getting temporary credentials..."
              TEMP_ROLE=$(aws sts assume-role \
                --role-arn "${ROLE_ARN}" \
                --role-session-name "dynamodb-list-tables-test" \
                --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
                --output text)

              if [ $? -ne 0 ]; then
                echo "ERROR: Failed to assume role ${ROLE_ARN}"
                exit 1
              fi

              export AWS_ACCESS_KEY_ID=$(echo $TEMP_ROLE | cut -d' ' -f1)
              export AWS_SECRET_ACCESS_KEY=$(echo $TEMP_ROLE | cut -d' ' -f2)
              export AWS_SESSION_TOKEN=$(echo $TEMP_ROLE | cut -d' ' -f3)

              echo "Successfully assumed role"

              echo "=== Listing DynamoDB tables ==="
              echo "(optional when using MeltanoLabs tap_dynamodb with hardcoded "tables" config)"

              # List all tables
              aws dynamodb list-tables --region ${AWS_DEFAULT_REGION}

              # Check specific ITX tables we need access to
              echo ""
              echo "=== Checking specific ITX tables ==="
              for table in "itx-poll" "itx-poll-vote" "itx-surveys" "itx-survey-responses" "itx-zoom-meetings-mappings-v2" "itx-zoom-meetings-v2" "itx-zoom-past-meetings-mappings" "itx-zoom-past-meetings" "itx-zoom-past-meetings-attendees" "itx-zoom-past-meetings-invitees" "itx-zoom-past-meetings-recordings" "itx-zoom-past-meetings-summaries" "itx-zoom-meetings-registrants-v2" "itx-zoom-meetings-invite-responses-v2"; do
                echo "Checking table: $table"
                aws dynamodb describe-table --table-name "$table" --region ${AWS_DEFAULT_REGION} --query 'Table.{TableName:TableName,Status:TableStatus,ItemCount:ItemCount}' --output table || echo "Failed to access table: $table"
              done

              echo ""
              echo "=== DynamoDB Access Test Complete ==="
          env:
            - name: AWS_DEFAULT_REGION
              value: "us-west-2"
            - name: AWS_REGION
              value: "us-west-2"
            # XXX: Replace ACCOUNT_ID with an actual ITX account ID
            # (dev/stg/prod) before applying.
            - name: ROLE_ARN
              #value: "arn:aws:iam::ACCOUNT_ID:role/v1-meltano-sync"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"
