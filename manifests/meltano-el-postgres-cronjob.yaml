# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: meltano-el-postgres-cronjob
  namespace: v1-sync-helper
  labels:
    app.kubernetes.io/name: lfx-v1-sync-helper
    app.kubernetes.io/component: meltano
spec:
  schedule: "*/5 * * * *" # Every 5 minutes
  concurrencyPolicy: Forbid # Prevent concurrent execution
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: lfx-v1-sync-helper
        app.kubernetes.io/component: meltano
    spec:
      ttlSecondsAfterFinished: 3600 # Clean up job after 1 hour
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: lfx-v1-sync-helper
            app.kubernetes.io/component: meltano
        spec:
          restartPolicy: Never
          containers:
            - name: meltano
              image: ghcr.io/linuxfoundation/lfx-v1-sync-helper/meltano:v0.4.2
              imagePullPolicy: Always
              workingDir: /app/meltano
              args:
                - el
                # Catalog from mounted ConfigMap
                - "--catalog"
                - "/catalogs/tap-postgres/catalog.json"
                # State ID for this el job
                - "--state-id"
                - platform-db-incremental
                # Source
                - tap-postgres
                # Target
                - target-nats-kv
              env:
                # Environment (prod/staging/dev per meltano.yml "environments" list)
                - name: MELTANO_ENVIRONMENT
                  value: "prod"
                # S3 state backend (prod/staging/dev suffix from OpenTofu workspace names)
                - name: MELTANO_STATE_BACKEND_URI
                  value: "s3://lfx-v2-meltano-state-prod"
                # AWS configuration for DynamoDB access
                - name: AWS_DEFAULT_REGION
                  value: "us-west-2"
                - name: AWS_REGION
                  value: "us-west-2"
                # Postgres configuration
                - name: TAP_POSTGRES_HOST
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials-ad-hoc
                      key: host
                      optional: true
                - name: TAP_POSTGRES_PORT
                  value: "5432"
                - name: TAP_POSTGRES_DATABASE
                  value: "sfdc"
                - name: TAP_POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials-ad-hoc
                      key: username
                      optional: true
                - name: TAP_POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-credentials-ad-hoc
                      key: password
                      optional: true
                # Target NATS KV configuration
                - name: TARGET_NATS_KV_URL
                  value: "nats://lfx-platform-nats.lfx.svc.cluster.local:4222"
                - name: TARGET_NATS_KV_BUCKET
                  value: "v1-objects"
                - name: TARGET_NATS_KV_REFRESH_MODE
                  value: "newer"
                - name: TARGET_NATS_KV_VALIDATE_RECORDS
                  # (true for PostgreSQL; false for DynamoDB)
                  value: "true"
                - name: TARGET_NATS_KV_MSGPACK
                  value: "true"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
              # Health check - Meltano jobs don't typically have health endpoints
              # but we can check if the process is running
              livenessProbe:
                exec:
                  command: ["pgrep", "-f", "meltano"]
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 3
              volumeMounts:
                - name: tap-postgres-catalog
                  mountPath: /catalogs/tap-postgres
                  readOnly: true
          volumes:
            - name: tap-postgres-catalog
              configMap:
                name: tap-postgres-catalog
          # Use service account with appropriate permissions for AWS
          serviceAccountName: v1-sync-helper-sa
